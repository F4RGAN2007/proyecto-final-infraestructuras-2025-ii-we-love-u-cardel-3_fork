name: Docker Compose Validation

on:
  push:
  pull_request:
    types: [opened, reopened]

jobs:
  compose-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Compose stack
      run: |
        docker compose build

    - name: Start services with Docker Compose
      run: |
        docker compose up -d

    - name: Wait for containers to stabilize
      run: |
        echo "Waiting 10 seconds for services to start..."
        sleep 10
        docker ps

    - name: Check logs for errors
      run: |
        echo "=== DB Logs ==="
        docker logs pokedex_db || true
        echo "=== Server Logs ==="
        docker logs pokedex_server || true
        echo "=== Client Logs ==="
        docker logs pokedex_client || true

    - name: Check if all containers are running
      run: |
        RUNNING=$(docker ps --filter "status=running" --format '{{.Names}}' | wc -l)
        if [ "$RUNNING" -lt 3 ]; then
          echo "Not all containers are running"
          docker ps -a
          exit 1
        fi
        echo "All containers running successfully."

    - name: Shut down Docker Compose
      if: always()
      run: |
        docker compose down -v
